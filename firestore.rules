rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserId() {
      return request.auth.uid;
    }

    function isCampaignMember(campaignId) {
      return isAuthenticated() && (
        // Check if campaign ID is in user's profile
        (exists(/databases/$(database)/documents/users/$(getUserId())) &&
          campaignId in get(/databases/$(database)/documents/users/$(getUserId())).data.campaigns) ||
        // Fallback: check campaign document directly
        (exists(/databases/$(database)/documents/campaigns/$(campaignId)) &&
          getUserId() in get(/databases/$(database)/documents/campaigns/$(campaignId)).data.members)
      );
    }

    function isCampaignOwner(campaignId) {
      return isAuthenticated() && (
        (exists(/databases/$(database)/documents/campaigns/$(campaignId)) &&
          get(/databases/$(database)/documents/campaigns/$(campaignId)).data.ownerId == getUserId()) ||
        (exists(/databases/$(database)/documents/campaigns/$(campaignId)/metadata) &&
          get(/databases/$(database)/documents/campaigns/$(campaignId)/metadata).data.ownerId == getUserId())
      );
    }

    function isSessionOwner(campaignId, sessionId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/campaigns/$(campaignId)/audioSessions/$(sessionId)) &&
        get(/databases/$(database)/documents/campaigns/$(campaignId)/audioSessions/$(sessionId)).data.ownerId == getUserId();
    }

    function isAdmin() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/users/$(getUserId())) &&
        get(/databases/$(database)/documents/users/$(getUserId())).data.admin == true;
    }

    // User profiles
    match /users/{userId} {
      allow read: if isAuthenticated();

      // Users can write to their own profile
      allow write: if isAuthenticated() && getUserId() == userId;

      // Allow adding campaigns to other users' profiles (for invitations)
      // Security is enforced by campaign document rules - users can only read campaigns they're members of
      allow update: if isAuthenticated() &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['campaigns', 'updatedAt']) &&
        // Ensure campaigns array only grows (no removals)
        request.resource.data.campaigns.hasAll(resource.data.get('campaigns', []));
    }

    // Campaigns
    match /campaigns/{campaignId} {
      allow read: if isCampaignMember(campaignId) ||
        !exists(/databases/$(database)/documents/campaigns/$(campaignId));
      allow create: if isAuthenticated() && request.resource.data.ownerId == getUserId();
      allow update: if isCampaignOwner(campaignId);
      allow delete: if isCampaignOwner(campaignId);
    }

    // Legacy campaign metadata (read-only during migration)
    match /campaigns/{campaignId}/metadata {
      allow read: if isCampaignMember(campaignId);
      allow create: if isAuthenticated() && request.resource.data.ownerId == getUserId();
      allow update: if isCampaignOwner(campaignId);
      allow delete: if isCampaignOwner(campaignId);
    }

    // Audio sessions in campaigns
    match /campaigns/{campaignId}/audioSessions/{sessionId} {
      allow read: if isCampaignMember(campaignId);

      allow create: if isCampaignMember(campaignId) &&
        request.resource.data.ownerId == getUserId();

      allow update: if isCampaignMember(campaignId) && (
        isSessionOwner(campaignId, sessionId) ||
        request.resource.data.diff(resource.data).affectedKeys().hasOnly([
          'userCorrections',
          'correctionsUpdatedAt',
          'updatedAt'
        ])
      );

      allow delete: if isSessionOwner(campaignId, sessionId);
    }

    // Subcollections of audio sessions
    match /campaigns/{campaignId}/audioSessions/{sessionId}/{subcollection=**} {
      allow read: if isCampaignMember(campaignId);
      allow write: if isSessionOwner(campaignId, sessionId);
    }

    // Settings collection - read-only for authenticated users
    match /settings/{document} {
      allow read: if isAuthenticated();
      // Admin-only writes
      allow write: if isAdmin();
    }
  }
}
