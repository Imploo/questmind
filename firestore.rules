rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserId() {
      return request.auth.uid;
    }

    function isCampaignMember(campaignId) {
      return isAuthenticated() && (
        (exists(/databases/$(database)/documents/campaigns/$(campaignId)) &&
          get(/databases/$(database)/documents/campaigns/$(campaignId)).data.members[getUserId()] != null) ||
        (exists(/databases/$(database)/documents/campaigns/$(campaignId)/metadata) &&
          get(/databases/$(database)/documents/campaigns/$(campaignId)/metadata).data.members[getUserId()] != null)
      );
    }

    function isCampaignOwner(campaignId) {
      return isAuthenticated() && (
        (exists(/databases/$(database)/documents/campaigns/$(campaignId)) &&
          get(/databases/$(database)/documents/campaigns/$(campaignId)).data.ownerId == getUserId()) ||
        (exists(/databases/$(database)/documents/campaigns/$(campaignId)/metadata) &&
          get(/databases/$(database)/documents/campaigns/$(campaignId)/metadata).data.ownerId == getUserId())
      );
    }

    function isSessionOwner(campaignId, sessionId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/campaigns/$(campaignId)/audioSessions/$(sessionId)) &&
        get(/databases/$(database)/documents/campaigns/$(campaignId)/audioSessions/$(sessionId)).data.ownerId == getUserId();
    }

    // User profiles
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && getUserId() == userId;
    }

    // Campaigns
    match /campaigns/{campaignId} {
      allow read: if isCampaignMember(campaignId) ||
        !exists(/databases/$(database)/documents/campaigns/$(campaignId));
      allow create: if isAuthenticated() && request.resource.data.ownerId == getUserId();
      allow update: if isCampaignOwner(campaignId);
      allow delete: if isCampaignOwner(campaignId);
    }

    // Legacy campaign metadata (read-only during migration)
    match /campaigns/{campaignId}/metadata {
      allow read: if isCampaignMember(campaignId);
      allow create: if isAuthenticated() && request.resource.data.ownerId == getUserId();
      allow update: if isCampaignOwner(campaignId);
      allow delete: if isCampaignOwner(campaignId);
    }

    // Audio sessions in campaigns
    match /campaigns/{campaignId}/audioSessions/{sessionId} {
      allow read: if isCampaignMember(campaignId);

      allow create: if isCampaignMember(campaignId) &&
        request.resource.data.ownerId == getUserId();

      allow update: if isCampaignMember(campaignId) && (
        isSessionOwner(campaignId, sessionId) ||
        request.resource.data.diff(resource.data).affectedKeys().hasOnly([
          'userCorrections',
          'correctionsUpdatedAt',
          'updatedAt'
        ])
      );

      allow delete: if isSessionOwner(campaignId, sessionId);
    }

    // Subcollections of audio sessions
    match /campaigns/{campaignId}/audioSessions/{sessionId}/{subcollection=**} {
      allow read: if isCampaignMember(campaignId);
      allow write: if isSessionOwner(campaignId, sessionId);
    }
  }
}
