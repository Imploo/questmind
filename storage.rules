rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    function isCampaignMember(campaignId) {
      return request.auth != null &&
        firestore.get(/databases/(default)/documents/campaigns/$(campaignId)/metadata)
          .data.members[request.auth.uid] != null;
    }

    // Audio files (campaigns)
    match /campaigns/{campaignId}/audio/{sessionId}/{filename} {
      allow read: if isCampaignMember(campaignId);
      allow write: if isCampaignMember(campaignId)
                   && request.resource.size < 500 * 1024 * 1024
                   && request.resource.contentType.matches('audio/.*');
    }

    // Podcast files (campaigns)
    match /campaigns/{campaignId}/podcasts/{sessionId}/{filename} {
      allow read: if isCampaignMember(campaignId);
      allow write: if isCampaignMember(campaignId)
                   && request.resource.size < 100 * 1024 * 1024
                   && (request.resource.contentType == 'audio/mpeg'
                       || request.resource.contentType == 'audio/mp3'
                       || request.resource.contentType == 'audio/m4a');
    }
  }
}
